builddir = build
cc = gcc
ar = ar
cflags = -funsigned-char -g -Wall -Werror -std=gnu11 -Wextra -Wno-deprecated -Wno-unused-parameter -m64 -Isrc

rule cc
    command = $cc -MMD -MT $out -MF $out.d $cflags -c $in -o $out
    # command = $cc -MMD -MF $out.d $cflags -c $in -o $out
    depfile = $out.d

rule ar
    command = rm -f $out && $ar crs $out $in

rule link
    command = $cc $in -o $out -lrt


# unittest library
build $builddir/src/unittest/unittest-main.o: cc src/unittest/unittest-main.c
build $builddir/src/unittest/unittest.o:      cc src/unittest/unittest.c
build $builddir/src/unittest/unittest.a:      ar $builddir/src/unittest/unittest-main.o $builddir/src/unittest/unittest.o

# unittest test
build $builddir/src/unittest/unittest-test.o: cc src/unittest/unittest-test.c
build $builddir/src/unittest/unittest-test:   link $builddir/src/unittest/unittest-test.o $builddir/src/unittest/unittest.a

# core library
build $builddir/src/core/memory.o:            cc src/core/memory.c
build $builddir/src/core/core.a:              ar $builddir/src/core/memory.o

# collections library
build $builddir/src/collections/hash-common.o:          cc src/collections/hash-common.c
build $builddir/src/collections/hash-functions.o:       cc src/collections/hash-functions.c
build $builddir/src/collections/hash-set-linear.o:      cc src/collections/hash-set-linear.c
build $builddir/src/collections/hash-map-linear.o:      cc src/collections/hash-map-linear.c
build $builddir/src/collections/murmur-hash3.o:         cc src/collections/murmur-hash3.c
build $builddir/src/collections/array.o:                cc src/collections/array.c
build $builddir/src/collections/collections.a:          ar $builddir/src/collections/hash-common.o $builddir/src/collections/hash-functions.o $builddir/src/collections/hash-set-linear.o $builddir/src/collections/hash-map-linear.o $builddir/src/collections/murmur-hash3.o $builddir/src/collections/array.o

# collections test
build $builddir/src/collections/hash-set-linear-test.o: cc src/collections/hash-set-linear-test.c
build $builddir/src/collections/hash-set-linear-test:   link $builddir/src/collections/hash-set-linear-test.o $builddir/src/collections/collections.a $builddir/src/storage/storage.a $builddir/src/core/core.a $builddir/src/unittest/unittest.a $builddir/src/utils/utils.a

build $builddir/src/collections/hash-map-linear-test.o: cc src/collections/hash-map-linear-test.c
build $builddir/src/collections/hash-map-linear-test:   link $builddir/src/collections/hash-map-linear-test.o $builddir/src/collections/collections.a $builddir/src/storage/storage.a $builddir/src/core/core.a $builddir/src/unittest/unittest.a $builddir/src/utils/utils.a

build $builddir/src/collections/array-test.o:           cc src/collections/array-test.c
build $builddir/src/collections/array-test:             link $builddir/src/collections/array-test.o $builddir/src/collections/collections.a $builddir/src/core/core.a $builddir/src/unittest/unittest.a

# storage library
build $builddir/src/storage/static-string.o:            cc src/storage/static-string.c
build $builddir/src/storage/storage.a:                  ar $builddir/src/storage/static-string.o

# storage test
build $builddir/src/storage/static-string-test.o:       cc src/storage/static-string-test.c
build $builddir/src/storage/static-string-test:         link $builddir/src/storage/static-string-test.o $builddir/src/storage/storage.a $builddir/src/collections/collections.a $builddir/src/unittest/unittest.a 

# utils library
build $builddir/src/utils/file.o:                       cc src/utils/file.c
build $builddir/src/utils/utils.a:                      ar $builddir/src/utils/file.o

